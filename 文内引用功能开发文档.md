# 文内引用功能开发文档

## 整体设计
文内引用功能用于在文章内引用当前论文的图/表/公式，在新版编辑器内用户点击文内引用块即可跳转到被引用内容位置。

文内引用功能作为Froala Editor的插件来实现

### 文内引用块在编辑器中的格式

```
<span data-froala-plugin-type='reference' contenteditable='false'>图: A</span>
```

# 功能模块

## 插入文内引用

### 说明
点击工具栏上的文内引用按钮，弹出选择框，框内列出当前论文中的表/图/公式供选择。选中后点击确定，将会在光标位置插入引用块。

### 技术实现
通过Froala Editor的Popup API管理弹出框，通过Froala Editor提供的html.insert来插入文本引用块。
文本引用块内容不可修改。

### 插入文内引用流程图

### UI图

## 文内引用块的交互

### 说明
当文内存在引用块，光标点击该引用块，编辑器会自动跳转到被引用内容位置附近。
当用户删除被引用块时，所有引用该块的被引用块也需要删除。

### 技术实现
在插入文内引用时，通过一张映射表记录引用块与被引用块之间的关系，在之后点击引用块时查找被引用块并跳转到该位置。
监听编辑器的contentChanged事件，在论文内容改变时判断，若删除内容包含被引用块，通过映射表找到引用块并进行删除引用块的操作。

## 删除文内引用

### 说明
光标定位于文本引用块尾部，单击backspace键即可删除文内引用块。

### 技术实现
文内引用块的contenteditable属性为false,无法直通过按下backspace键删除。需要在按下backspace时检测光标左边是否存在文内引用块，若存在则删除之。
当光标位于文内引用块后的块，并且在下一步删除了后块，此时仍然会删除文内引用块，因为keydown事件是在删除元素后才会被调用，此时光标左边已是文内引用块，所以造成误删。为了解决这一问题，使用中间变量始终记录光标上一次所在位置的左侧元素，当中间变量为空或为引用块且当前光标左侧为引用块时，才删除该引用块。

### 流程图